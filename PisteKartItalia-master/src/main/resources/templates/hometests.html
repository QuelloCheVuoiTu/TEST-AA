<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Racing Tracks - Minimal Lucido Dinamico</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Font Awesome per le icone -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * {
            margin:0;
            padding:0;
            box-sizing:border-box;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            color: rgba(255, 255, 255, 0.85);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: url('/sfondo.jpg') center center/cover no-repeat;
            opacity: 0.25;
            z-index: 0;
            pointer-events: none;
        }
        body {
            position: relative;
            z-index: 1;
        }

        /* Navbar minimal con effetto vetro */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 15px 5%;
            border-bottom: 1px solid rgba(255, 60, 60, 0.2);
            width: 100%;
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: all 0.4s ease;
        }
        .navbar:hover {
            background: rgba(30, 30, 30, 0.8);
            border-bottom: 1px solid rgba(255, 60, 60, 0.4);
        }
        .navbar .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.6rem;
            font-weight: 600;
            color: #fff;
            text-align: center;
            letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(255, 60, 60, 0.5);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .navbar .logo:hover {
            transform: scale(1.05);
            text-shadow: 0 0 15px rgba(255, 60, 60, 0.8);
        }
        .navbar ul {
            display: flex;
            list-style: none;
            gap: 30px;
        }
        .navbar ul li a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-weight: 400;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            padding: 8px 0;
            position: relative;
        }
        .navbar ul li a:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 1px;
            background: #ff3c3c;
            transition: width 0.3s ease;
        }
        .navbar ul li a:hover {
            color: #fff;
        }
        .navbar ul li a:hover:after {
            width: 100%;
        }

        /* Sezione Powered by Vroom */
        .powered-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(255, 60, 60, 0.1);
        }
        .powered-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
            letter-spacing: 2px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        .vroom-logo {
            width: 120px;
            height: 40px;
            background: linear-gradient(45deg, #ff3c3c, #ff7b7b);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
            font-size: 1.5rem;
            color: white;
            box-shadow: 0 0 15px rgba(255, 60, 60, 0.4);
            transition: all 0.3s ease;
        }
        .vroom-logo:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 60, 60, 0.6);
        }

        /* Sezione Video Carosello - MOBILE OPTIMIZED */
        .videos-carousel {
            width: 100%;
            padding: 30px 5%;
            margin-bottom: 30px;
            position: relative;
        }

        .videos-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            text-align: center;
            margin-bottom: 30px;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 60, 60, 0.4);
        }

        .videos-container {
            position: relative;
            max-width: 1400px;
            margin: 0 auto;
            overflow: hidden;
            padding: 0 20px;
        }

        .videos-track {
            position: relative;
            height: 420px; /* piÃ¹ spazio verticale */
            min-width: 900px;
        }

        .video-item {
            position: absolute;
            top: 50%;
            left: 50%;
            transition: transform 0.6s cubic-bezier(0.25,0.46,0.45,0.94), opacity 0.6s;
            opacity: 0.2;
            z-index: 0;
            width: 400px;
            height: 300px;
            display: none;
        }

        /* Video attivo (centrale) - DESKTOP */
        .video-item.active {
            width: 600px;
            height: 338px;
        }

        .video-item.side {
            width: 320px;
            height: 220px;
            z-index: 1;
            opacity: 0.7;
        }

        /* Video adiacenti - DESKTOP */
        .video-item.adjacent {
            width: 400px;
            height: 225px;
        }
        /* Video lontani - DESKTOP */
        .video-item.far {
            width: 260px;
            height: 146px;
        }

        /* Video nascosti */
        .video-item.hidden {
            opacity: 0.3;
            transform: scale(0.8);
            z-index: 0;
        }

        /* MOBILE STYLES */
        @media (max-width: 768px) {
            .videos-carousel {
                padding: 20px 0;
            }

            .videos-container {
                padding: 0 10px;
            }

            .videos-track {
                height: 250px;
            }

            /* Su mobile, il video attivo occupa quasi tutto lo spazio */
            .video-item.active {
                flex: 0 0 85% !important;
                transform: scale(1) !important;
                margin: 0 -5px !important;
                z-index: 3;
            }

            /* Su mobile, nascondiamo quasi completamente gli altri video */
            .video-item:not(.active) {
                flex: 0 0 15% !important;
                transform: scale(0.8) !important;
                opacity: 0.3 !important;
                margin: 0 -25px !important;
                z-index: 1;
            }

            /* Migliora la leggibilitÃ  del titolo su mobile */
            .videos-title {
                font-size: 1.5rem;
                margin-bottom: 20px;
            }

            /* Riduci padding generale su mobile */
            .filter-results-section,
            .map-tab-container {
                padding: 20px 3%;
            }
        }

        @media (max-width: 480px) {
            .videos-track {
                height: 220px;
            }

            .video-item.active {
                flex: 0 0 90% !important;
                margin: 0 -2px !important;
            }

            .video-item:not(.active) {
                flex: 0 0 10% !important;
                margin: 0 -30px !important;
            }
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 */
            overflow: hidden;
        }

        .video-wrapper iframe {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
            object-fit: cover;
            background: #000;
        }


        /* Navigazione migliorata */
        .videos-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 40px;
        }
        .videos-nav-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            z-index: 10;
        }
        .videos-nav-btn:hover {
            background: rgba(255, 60, 60, 0.3);
            transform: scale(1.15);
            border-color: rgba(255, 60, 60, 0.5);
            box-shadow: 0 0 20px rgba(255, 60, 60, 0.4);
        }

        /* Indicatori di posizione rullino video*/
        .video-indicators {
            display: flex;
            gap: 10px;
        }
        .video-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .video-indicator.active {
            background: #ff3c3c;
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(255, 60, 60, 0.6);
        }
        .video-indicator:hover {
            background: rgba(255, 60, 60, 0.6);
            transform: scale(1.1);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .video-item { margin: 0 -30px; }
            .video-item.active { margin: 0 -15px; }
            .video-item.adjacent { margin: 0 -25px; }
            .video-item.far { margin: 0 -35px; }
        }

        @media (max-width: 900px) {
            .videos-container { padding: 0 40px; }
            .video-item { margin: 0 -20px; }
            .video-item.active { margin: 0 -10px; }
            .video-item.adjacent { margin: 0 -15px; }
            .video-item.far { margin: 0 -25px; }
        }

        @media (max-width: 600px) {
            .videos-container { padding: 0 20px; }
            .videos-track { height: 300px; }
            .video-item { margin: 0 -15px; }
            .video-item.active { margin: 0 -8px; }
            .video-item.adjacent { margin: 0 -12px; }
            .video-item.far { margin: 0 -18px; }
        }

        /* Slideshow eventi */
        .events-slideshow {
            width: 100%;
            padding: 40px 5%;
            margin-bottom: 30px;
        }
        .events-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            text-align: center;
            margin-bottom: 30px;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 60, 60, 0.4);
        }
        .events-container {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
            overflow: hidden;
        }
        .events-track {
            display: flex;
            transition: transform 0.5s ease;
            gap: 25px;
        }
        .event-card {
            flex: 0 0 calc(33.333% - 17px);
            background: rgba(25, 25, 25, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.4s ease;
        }
        .event-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 60, 60, 0.3);
            border: 1px solid rgba(255, 60, 60, 0.3);
        }
        .event-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .event-content {
            padding: 20px;
        }
        .event-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #fff;
        }
        .event-description {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 15px;
            line-height: 1.5;
        }
        .event-link {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(255, 60, 60, 0.2);
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            border: 1px solid rgba(255, 60, 60, 0.3);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .event-link:hover {
            background: rgba(255, 60, 60, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 60, 60, 0.2);
        }
        .events-nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }
        .events-nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .events-nav-btn:hover {
            background: rgba(255, 60, 60, 0.2);
            transform: scale(1.1);
        }

        /* Sezione filtro + lista */
        .filter-results-section {
            display: flex;
            gap: 25px;
            padding: 30px 5%;
            justify-content: center;
            width: 100%;
            max-width: 1400px;
        }
        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 250px;
            flex: 1;
            background: rgba(25, 25, 25, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.4s ease;
            transform-origin: center left;
        }
        .filter-section:hover {
            transform: scale(1.02);
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .filter-section h3 {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 5px;
            color: rgba(255, 255, 255, 0.9);
        }
        .filter-section select, .filter-section button {
            padding: 12px 16px;
            font-size: 0.95rem;
            border: none;
            outline: none;
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .filter-section select:hover, .filter-section button:hover {
            background: rgba(255, 60, 60, 0.2);
            cursor: pointer;
            transform: scale(1.03);
        }
        .filter-section select:focus {
            background: rgba(255, 255, 255, 0.12);
            transform: scale(1.03);
        }

        /* Lista verticale minimal con effetto vetro */
        .results-tab {
            flex: 1;
            max-height: 350px;
            overflow-y: auto;
            background: rgba(25, 25, 25, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.4s ease;
            transform-origin: center right;
        }
        .results-tab:hover {
            transform: scale(1.02);
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .results-tab::-webkit-scrollbar {
            width: 6px;
        }
        .results-tab::-webkit-scrollbar-thumb {
            background: rgba(255, 60, 60, 0.3);
            border-radius: 3px;
            transition: all 0.3s ease;
        }
        .results-tab::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 60, 60, 0.5);
            transform: scale(1.1);
        }
        .track-row {
            padding: 14px 16px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 2px solid transparent;
            transform-origin: center;
        }
        .track-row:hover {
            background: rgba(255, 60, 60, 0.15);
            border-left: 2px solid #ff3c3c;
            transform: translateX(5px) scale(1.03);
        }

        /* Layout mappa + info con effetto vetro */
        .map-tab-container {
            display: flex;
            gap: 25px;
            padding: 0 5% 40px;
            justify-content: center;
            width: 100%;
            max-width: 1400px;
        }
        #map {
            height: 500px;
            flex: 2;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.4s ease;
        }
        #map:hover {
            transform: scale(1.02);
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .track-info {
            flex: 1;
            background: rgba(25, 25, 25, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: all 0.4s ease;
        }
        .track-info:hover {
            transform: scale(1.02);
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .track-info h3 {
            margin-bottom: 15px;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
            font-weight: 500;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }
        .track-info:hover h3 {
            text-shadow: 0 0 10px rgba(255, 60, 60, 0.4);
        }
        .track-info p {
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.7);
        }
        .track-info a.button {
            display: inline-block;
            padding: 12px 24px;
            background: rgba(255, 60, 60, 0.2);
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            border: 1px solid rgba(255, 60, 60, 0.3);
            border-radius: 8px;
            font-weight: 500;
            margin-top: 15px;
            transition: all 0.3s ease;
            text-align: center;
        }
        .track-info a.button:hover {
            background: rgba(255, 60, 60, 0.3);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 60, 60, 0.2);
        }

        /* Effetti di ingrandimento per i marker */
        .custom-marker {
            transition: all 0.3s ease;
            filter: drop-shadow(0 0 4px rgba(255, 60, 60, 0.7));
        }
        .custom-marker:hover {
            transform: scale(1.3);
            filter: drop-shadow(0 0 8px rgba(255, 60, 60, 0.9));
        }

        /* Responsive design */
        @media (max-width: 900px) {
            .filter-results-section,
            .map-tab-container {
                flex-direction: column;
            }

            .filter-section,
            .results-tab,
            #map,
            .track-info {
                width: 100%;
            }

            .navbar ul {
                gap: 15px;
            }

            .event-card {
                flex: 0 0 calc(50% - 12px);
            }

            /* Riduci gli effetti di scaling su mobile */
            .filter-section:hover,
            .results-tab:hover,
            #map:hover,
            .track-info:hover,
            .event-card:hover {
                transform: scale(1);
            }
        }

        @media (max-width: 600px) {
            .event-card {
                flex: 0 0 100%;
            }
        }

        /* Loader */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid #ff3c3c;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #ff3c3c;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<div class="navbar">
    <div class="logo" onclick="window.location.href='/'">
        <img src="/logoPisteKart.png" alt="Logo PisteKart" height="40">
    </div>
    <ul>
        <li><a href="#">Home</a></li>
        <li><a href="#">Tracciati</a></li>
        <li><a href="#">Info</a></li>
    </ul>
</div>

<!-- Sezione Powered by Vroom -->
<div class="powered-section">
    <div class="powered-text">POWERED BY</div>
    <img src="/vroomlogo.png" alt="Logo PisteKart" style="height:25px;">
</div>

<!-- Slideshow Video YouTube -->
<div class="videos-carousel" th:if="${not promotedVideos.empty}">
    <h2 class="videos-title">Karting TV</h2>
    <div class="videos-container">
        <div class="videos-track" id="videosTrack">
            <!-- I video verranno generati dinamicamente -->
        </div>
        <div class="videos-nav">
            <div class="videos-nav-btn" id="prevVideo">
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="video-indicators"></div>
            <div class="videos-nav-btn" id="nextVideo">
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
    </div>
</div>

<!-- Slideshow Eventi -->
<div class="events-slideshow">
    <h2 class="events-title">Eventi in Evidenza</h2>
    <div class="events-container">
        <div class="events-track" id="eventsTrack">
            <!-- Le card degli eventi verranno generate dinamicamente -->
        </div>
        <div class="events-nav">
            <div class="events-nav-btn" id="prevEvent">
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="events-nav-btn" id="nextEvent">
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
    </div>
</div>

<!-- Sezione filtro + lista -->
<div class="filter-results-section">
    <div class="filter-section">
        <h3>Filtra per:</h3>
        <select id="regionFilter">
            <option value="">Tutte le regioni</option>
            <!-- Le opzioni delle regioni verranno caricate dinamicamente -->
        </select>
        <select id="gradoFilter">
            <option value="">Tutti i gradi</option>
            <!-- Le opzioni dei gradi verranno caricate dinamicamente -->
        </select>
        <button onclick="applyFilters()">Applica Filtri</button>
    </div>

    <div class="results-tab" id="resultsTab">
        <div class="loader" id="loader"></div>
        <!-- Lista verticale verrÃ  generata dinamicamente -->
    </div>
</div>

<!-- Mappa e Tab info -->
<div class="map-tab-container">
    <div id="map"></div>
    <div class="track-info" id="trackInfo">
        <h3>Seleziona una pista</h3>
        <p id="trackRegion"></p>
        <p id="trackGrado"></p>
        <a href="#" id="trackLink" class="button">Vai alla pagina pista</a>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script th:inline="javascript">
    let allTracks = []; // Memorizza tutti i tracciati recuperati dal database
    let filteredTracks = []; // Tracciati filtrati
    let markers = []; // Marker sulla mappa


    // Variabili globali per il carosello video avanzato
    let currentVideoIndex = 2; // INIZIA DAL TERZO ELEMENTO (indice 2)
    let videoAutoPlayTimer = null;
    let userInteracted = false;
    let promotedVideos = [];

    // Inizializza il carosello video
    function initVideosCarousel() {
        const videosTrack = document.getElementById('videosTrack');
        promotedVideos = /*[[${promotedVideos}]]*/ [];
        if (!Array.isArray(promotedVideos) || promotedVideos.length === 0) {
            document.querySelector('.videos-carousel').style.display = 'none';
            return;
        }
        videosTrack.innerHTML = '';
        promotedVideos.forEach((videoUrl, i) => {
            const videoId = extractYouTubeId(videoUrl);
            if (!videoId) return;
            const videoItem = document.createElement('div');
            videoItem.className = 'video-item';
            videoItem.setAttribute('data-index', i);
            videoItem.innerHTML = `
              <div class="video-wrapper">
                <iframe
                  src="https://www.youtube.com/embed/${videoId}?enablejsapi=1&autoplay=1&rel=0&showinfo=0"
                  allow="autoplay; encrypted-media"
                  allowfullscreen
                  frameborder="0"
                  data-index="${i}">
                </iframe>
              </div>
            `;
            videosTrack.appendChild(videoItem);
        });
        updateVideoCarousel();
        setupVideoCarouselNavigation();
        setTimeout(() => {
            if (!userInteracted) {
                playCurrentVideo();
                startVideoAutoPlay();
            }
        }, 500);
    }

    // Mostra 5 video, autoplay solo sul centrale, audio solo sul centrale
    function updateVideoCarousel() {
        const videoItems = document.querySelectorAll('.video-item');
        videoItems.forEach((item, i) => {
            item.className = 'video-item';
            item.style.display = 'none';

            // Bordo sinistra
            if (i === (currentVideoIndex - 2 + promotedVideos.length) % promotedVideos.length) {
                item.classList.add('far');
                item.style.display = 'block';
                item.style.transform = 'translate(calc(-50% - 520px), -50%) scale(0.85)';
                item.style.zIndex = 1;
                item.style.opacity = 0.6;
                setIframeMute(item, true);
            }
            // Adiacente sinistra
            else if (i === (currentVideoIndex - 1 + promotedVideos.length) % promotedVideos.length) {
                item.classList.add('adjacent');
                item.style.display = 'block';
                item.style.transform = 'translate(calc(-50% - 300px), -50%) scale(1)';
                item.style.zIndex = 2;
                item.style.opacity = 0.85;
                setIframeMute(item, true);
            }
            // Centrale
            else if (i === currentVideoIndex) {
                item.classList.add('active');
                item.style.display = 'block';
                item.style.transform = 'translate(-50%, -50%) scale(1.15)';
                item.style.zIndex = 3;
                item.style.opacity = 1;
                setIframeMute(item, false);
                playCurrentVideo();
            }
            // Adiacente destra
            else if (i === (currentVideoIndex + 1) % promotedVideos.length) {
                item.classList.add('adjacent');
                item.style.display = 'block';
                item.style.transform = 'translate(calc(-50% + 300px), -50%) scale(1)';
                item.style.zIndex = 2;
                item.style.opacity = 0.85;
                setIframeMute(item, true);
            }
            // Bordo destra
            else if (i === (currentVideoIndex + 2) % promotedVideos.length) {
                item.classList.add('far');
                item.style.display = 'block';
                item.style.transform = 'translate(calc(-50% + 520px), -50%) scale(0.85)';
                item.style.zIndex = 1;
                item.style.opacity = 0.6;
                setIframeMute(item, true);
            }
            item.style.left = '50%';
            item.style.top = '50%';
            item.style.transition = 'transform 0.6s cubic-bezier(0.25,0.46,0.45,0.94), opacity 0.6s';
        });
        updateVideoIndicators();
    }

    // Navigazione
    function setupVideoCarouselNavigation() {
        document.getElementById('nextVideo').onclick = () => {
            userInteracted = true;
            stopVideoAutoPlay();
            currentVideoIndex = (currentVideoIndex + 1) % promotedVideos.length;
            updateVideoCarousel();
            playCurrentVideo();
        };
        document.getElementById('prevVideo').onclick = () => {
            userInteracted = true;
            stopVideoAutoPlay();
            currentVideoIndex = (currentVideoIndex - 1 + promotedVideos.length) % promotedVideos.length;
            updateVideoCarousel();
            playCurrentVideo();
        };
    }

    // Muta o attiva audio su iframe
    function setIframeMute(item, mute) {
        const iframe = item.querySelector('iframe');
        if (iframe) {
            iframe.contentWindow.postMessage(`{"event":"command","func":"${mute ? 'mute' : 'unMute'}","args":""}`, '*');
            if (mute) {
                iframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
            }
        }
    }

    // Autoplay solo sul centrale
    function playCurrentVideo() {
        const videoItems = document.querySelectorAll('.video-item');
        const currentIframe = videoItems[currentVideoIndex]?.querySelector('iframe');
        if (currentIframe) {
            // Invia play solo se l'API Ã¨ pronta
            currentIframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
            currentIframe.contentWindow.postMessage('{"event":"command","func":"unMute","args":""}', '*');
        }
    }

    // Autoplay timer
    function startVideoAutoPlay() {
        if (userInteracted || promotedVideos.length <= 1) return;
        videoAutoPlayTimer = setInterval(() => {
            currentVideoIndex = (currentVideoIndex + 1) % promotedVideos.length;
            updateVideoCarousel();
        }, 10000);
    }
    function stopVideoAutoPlay() {
        if (videoAutoPlayTimer) clearInterval(videoAutoPlayTimer);
        videoAutoPlayTimer = null;
    }

    // Indicatori
    function updateVideoIndicators() {
        const indicatorsContainer = document.querySelector('.video-indicators');
        if (!indicatorsContainer) return;
        indicatorsContainer.innerHTML = '';
        promotedVideos.forEach((_, i) => {
            const indicator = document.createElement('div');
            indicator.className = 'video-indicator' + (i === currentVideoIndex ? ' active' : '');
            indicator.onclick = () => {
                userInteracted = true;
                stopVideoAutoPlay();
                currentVideoIndex = i;
                updateVideoCarousel();
                playCurrentVideo();
            };
            indicatorsContainer.appendChild(indicator);
        });
    }

    // Estrai ID YouTube
    function extractYouTubeId(url) {
        const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
        const match = url.match(regex);
        return match ? match[1] : null;
    }













    // Mappa
    const map = L.map('map').setView([42.5,12.5],6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    }).addTo(map);

    // Creazione di un icona personalizzata per i marker
    const customIcon = L.divIcon({
        className: 'custom-marker',
        html: '<div style="background-color: #ff3c3c; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(255, 60, 60, 0.7);"></div>',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });


    //!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! SPOTTATA CHIAMATA DIRETTA ALLE API REST, RISOLVERE !!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    // Funzione per recuperare i tracciati dal database
    async function fetchTracks() {
        try {
            const response = await fetch('/api/tracks');
            if (!response.ok) throw new Error('Errore nel recupero dei dati');
            allTracks = await response.json();
            populateFilters();
            applyFilters();
        } catch (error) {
            console.error('Errore:', error);
            document.getElementById('resultsTab').innerHTML = '<p>Errore nel caricamento dei dati</p>';
        } finally {
            // CORREGGI: controlla se l'elemento esiste prima di modificarlo
            const loader = document.getElementById('loader');
            if (loader) {
                loader.style.display = 'none';
            }
        }
    }

    // Popola i menu a tendina con i valori unici
    function populateFilters() {
        const regionFilter = document.getElementById('regionFilter');
        const gradoFilter = document.getElementById('gradoFilter');

        // Estrai regioni e gradi unici
        const regions = [...new Set(allTracks.map(track => track.regione))].filter(Boolean).sort();
        const grades = [...new Set(allTracks.map(track => track.grado))].filter(Boolean).sort();

        // Aggiungi le regioni al filtro
        regions.forEach(region => {
            const option = document.createElement('option');
            option.value = region;
            option.textContent = region;
            regionFilter.appendChild(option);
        });

        // Aggiungi i gradi al filtro
        grades.forEach(grade => {
            const option = document.createElement('option');
            option.value = grade;
            option.textContent = grade;
            gradoFilter.appendChild(option);
        });
    }

    // Inizializzazione slideshow eventi con dati reali
    function initEventsSlider() {
        console.log("ðŸŽ¯ INIT EVENT SLIDER CHIAMATO");

        const eventsTrack = document.getElementById('eventsTrack');
        if (!eventsTrack) {
            console.error("âŒ eventsTrack element non trovato!");
            return;
        }

        // USA DIRETTAMENTE I DATI THYMELEAF
        const promotedEvents = /*[[${promotedEvents}]]*/ [];

        console.log("=== DEBUG JAVASCRIPT ===");
        console.log("ðŸ“Š promotedEvents:", promotedEvents);
        console.log("ðŸ” Tipo:", typeof promotedEvents);
        console.log("ðŸ“‹ Ãˆ array?", Array.isArray(promotedEvents));
        console.log("ðŸ”¢ Lunghezza:", promotedEvents.length);

        // DEBUG DETTAGLIATO degli eventi
        if (Array.isArray(promotedEvents)) {
            promotedEvents.forEach((event, index) => {
                console.log(`   Evento ${index}:`, event);
            });
        }

        if (!Array.isArray(promotedEvents) || promotedEvents.length === 0) {
            console.log("âŒ Array VUOTO o non array!");
            showNoEventsMessage(eventsTrack);
            return;
        }

        console.log(`âœ… ${promotedEvents.length} eventi promossi caricati - CREAZIONE CARD`);

        // Pulisci il container
        eventsTrack.innerHTML = '';

        // Crea le card con gli eventi REALI
        promotedEvents.forEach((event, index) => {
            console.log(`ðŸ”„ Creando card ${index}:`, event.titolo);

            // Formatta la data
            const eventDate = new Date(event.data);
            const formattedDate = eventDate.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const eventCard = document.createElement('div');
            eventCard.className = 'event-card';
            eventCard.innerHTML = `
            <img src="${event.foto || 'https://placehold.co/600x400/1a1a1a/ff3c3c?text=Evento+Kart'}"
                 alt="${event.titolo}" class="event-image"
                 onerror="this.src='https://placehold.co/600x400/1a1a1a/ff3c3c?text=Evento+Kart'">
            <div class="event-content">
                <h3 class="event-title">${event.titolo}</h3>
                <p class="event-description">${event.descrizione || 'Descrizione non disponibile'}</p>

                <!-- Informazioni aggiuntive -->
                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-bottom: 10px; line-height: 1.4;">
                    <div><i class="fas fa-map-marker-alt" style="margin-right: 5px;"></i> ${event.trackName}</div>
                    <div><i class="fas fa-calendar-alt" style="margin-right: 5px;"></i> ${formattedDate}</div>
                    <div><i class="fas fa-user" style="margin-right: 5px;"></i> Org. ID: ${event.idOrganizzatore}</div>
                </div>

                ${event.linkEsterno ?
                `<a href="${event.linkEsterno}" class="event-link" target="_blank">Scopri di piÃ¹</a>` :
                '<a href="#" class="event-link">Dettagli evento</a>'
            }
            </div>
        `;
            eventsTrack.appendChild(eventCard);
            console.log(`âœ… Card ${index} creata: ${event.titolo}`);
        });

        console.log("ðŸŽ‰ TUTTE LE CARD CREATE CON SUCCESSO!");
        setupEventSliderNavigation();
    }

    function showNoEventsMessage(container, message) {
        console.log(`ðŸ“¢ Mostrando messaggio: ${message}`);
        container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6); width: 100%;">
            <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
            <p>${message}</p>
            <p style="font-size: 0.8rem; margin-top: 10px;">Controlla la console per i dettagli</p>
        </div>
    `;
        document.querySelector('.events-nav').style.display = 'none';
    }

    function showNoEventsMessage(container) {
        container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6); width: 100%;">
            <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
            <p>Nessun evento in evidenza al momento</p>
        </div>
    `;
        document.querySelector('.events-nav').style.display = 'none';
    }

    function setupEventSliderNavigation() {
        let currentPosition = 0;
        const eventCards = document.querySelectorAll('.event-card');

        if (eventCards.length === 0) {
            console.log('Nessuna card trovata per la navigazione');
            return;
        }

        const cardWidth = eventCards[0].offsetWidth + 25;
        const visibleCards = Math.min(3, eventCards.length);

        console.log(`Slideshow: ${eventCards.length} cards, ${visibleCards} visibili`);

        document.getElementById('nextEvent').addEventListener('click', () => {
            const maxPosition = -(eventCards.length - visibleCards) * cardWidth;
            if (currentPosition > maxPosition) {
                currentPosition -= cardWidth;
                eventsTrack.style.transform = `translateX(${currentPosition}px)`;
                console.log('Next - Posizione:', currentPosition);
            }
        });

        document.getElementById('prevEvent').addEventListener('click', () => {
            if (currentPosition < 0) {
                currentPosition += cardWidth;
                eventsTrack.style.transform = `translateX(${currentPosition}px)`;
                console.log('Prev - Posizione:', currentPosition);
            }
        });
    }

    // Lista e interazioni
    function updateResultsTab() {
        const resultsTab = document.getElementById('resultsTab');
        resultsTab.innerHTML = '';

        if (filteredTracks.length === 0) {
            resultsTab.innerHTML = '<p>Nessun tracciato trovato con i filtri selezionati</p>';
            return;
        }

        filteredTracks.forEach((track, i) => {
            const row = document.createElement('div');
            row.className = 'track-row';
            row.innerHTML = `<strong>${track.nome}</strong><br><span style="font-size: 0.85em; opacity: 0.8;">${track.regione} - ${track.grado}</span>`;
            row.addEventListener('mouseover', () => {
                showTrackInfo(track);
                map.setView([track.latitudine, track.longitudine], 8);
                highlightRow(i);
                highlightMarker(i);
            });
            row.addEventListener('mouseout', () => {
                resetRowHighlights();
                resetMarkerHighlights();
            });
            row.addEventListener('click', () => {
                showTrackInfo(track);
                map.setView([track.latitudine, track.longitudine], 10);
            });
            resultsTab.appendChild(row);
        });
        console.log('updateResultsTab chiamata, risultati:', filteredTracks.length);
    }

    function highlightRow(activeIndex) {
        document.querySelectorAll('.track-row').forEach((row, i) => {
            if (i === activeIndex) {
                row.style.background = 'rgba(255, 60, 60, 0.2)';
                row.style.borderLeft = '2px solid #ff3c3c';
                row.style.transform = 'translateX(8px) scale(1.05)';
            } else {
                row.style.background = 'rgba(255, 255, 255, 0.05)';
                row.style.borderLeft = '2px solid transparent';
                row.style.transform = 'scale(0.97)';
            }
        });
    }

    function resetRowHighlights() {
        document.querySelectorAll('.track-row').forEach(row => {
            row.style.background = 'rgba(255, 255, 255, 0.05)';
            row.style.borderLeft = '2px solid transparent';
            row.style.transform = 'scale(1)';
        });
    }

    function highlightMarker(activeIndex) {
        markers.forEach((marker, i) => {
            if (i === activeIndex) {
                marker.getElement().classList.add('highlighted');
                marker.setZIndexOffset(1000);
            } else {
                marker.getElement().classList.remove('highlighted');
                marker.setZIndexOffset(0);
            }
        });
    }

    function resetMarkerHighlights() {
        markers.forEach(marker => {
            marker.getElement().classList.remove('highlighted');
            marker.setZIndexOffset(0);
        });
    }

    function applyFilters() {
        const region = document.getElementById('regionFilter').value;
        const grado = document.getElementById('gradoFilter').value;

        // Filtra i tracciati
        filteredTracks = allTracks.filter(track => {
            return (region === "" || track.regione === region) &&
                (grado === "" || track.grado === grado);
        });

        // Rimuovi markers esistenti
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

        // Aggiungi nuovi markers
        filteredTracks.forEach(track => {
            const marker = L.marker([track.latitudine, track.longitudine], {icon: customIcon})
                .addTo(map)
                .bindPopup(`<b style="color: #ff3c3c;">${track.nome}</b><br>${track.regione} - ${track.grado}`)
                .on('click', () => showTrackInfo(track))
                .on('mouseover', function() {
                    this.openPopup();
                    // Trova l'indice del marker
                    const index = filteredTracks.findIndex(t =>
                        t.latitudine === track.latitudine && t.longitudine === track.longitudine
                    );
                    if (index !== -1) {
                        highlightRow(index);
                    }
                })
                .on('mouseout', function() {
                    resetRowHighlights();
                });
            markers.push(marker);
        });

        if (filteredTracks.length > 0) {
            const firstTrack = filteredTracks[0];
            map.setView([firstTrack.latitudine, firstTrack.longitudine], 7);
            showTrackInfo(firstTrack);
        } else {
            // Nessun risultato trovato
            document.getElementById('trackInfo').innerHTML = '<h3>Nessun risultato trovato</h3><p>Prova con altri filtri</p>';
        }

        updateResultsTab();
    }

    function showTrackInfo(track) {
        // Costruisci l'URL corretto usando l'ID della pista
        const trackUrl = `/pista/${track.id}`;

        document.getElementById('trackInfo').innerHTML = `
        <h3>${track.nome}</h3>
        <p>Regione: ${track.regione}</p>
        <p>Grado: ${track.grado}</p>
        <p>CittÃ : ${track.citta}</p>
        <p>Lunghezza: ${track.lunghezza}m</p>
        <p>Capienza: ${track.capienza} kart</p>
        ${track.note ? `<p>Note: ${track.note}</p>` : ''}
        <a href="${trackUrl}" class="button">Vai alla pagina pista</a>
    `;
    }



    // Inizializzazione - AGGIUNGI DEBUG
    // Inizializzazione - carica prima eventi e piste, poi i video
    document.addEventListener('DOMContentLoaded', async () => {
        const loader = document.getElementById('loader');
        if (loader) loader.style.display = 'block';

        try {
            await new Promise(resolve => { initEventsSlider(); resolve(); });
            await fetchTracks();
            await new Promise(resolve => { initVideosCarousel(); resolve(); });

            playCurrentVideo(); // Avvia solo il centrale

            // Fake click solo sul video centrale appena caricato
            fakeUserInteractionOnCurrentVideo();
        } catch (error) {
            console.error("Errore durante l'inizializzazione:", error);
        } finally {
            if (loader) loader.style.display = 'none';
            console.log("âœ… Eventi, tracciati e video caricati");
        }
    });

    // Funzione per fake click
    function fakeUserInteractionOnCurrentVideo() {
        const videoItems = document.querySelectorAll('.video-item');
        const currentIframe = videoItems[currentVideoIndex]?.querySelector('iframe');
        if (currentIframe) {
            const event = new MouseEvent('click', { bubbles: true, cancelable: true });
            currentIframe.dispatchEvent(event);
            console.log('ðŸŸ¢ Finta interazione inviata solo al video centrale');
        }
    }

    function fakeUserInteractionOnCurrentVideo() {
        const videoItems = document.querySelectorAll('.video-item');
        const currentIframe = videoItems[currentVideoIndex]?.querySelector('iframe');
        if (currentIframe) {
            const event = new MouseEvent('click', { bubbles: true, cancelable: true });
            currentIframe.dispatchEvent(event);
            console.log('ðŸŸ¢ Finta interazione inviata solo al video centrale');
        }
    }

    // Aggiungi effetto di respiro al logo
    const logo = document.querySelector('.logo');
    if (logo) {
        setInterval(() => {
            logo.style.textShadow = `0 0 ${10 + Math.sin(Date.now()/1000)*5}px rgba(255, 60, 60, 0.5)`;
        }, 100);
    }
</script>
</body>
</html>